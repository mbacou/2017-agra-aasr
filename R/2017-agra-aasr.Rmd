---
title: Business-oriented Typology and Characterization of Agriculture in SSA
author: "[Melanie Bacou](http://github.com/mbacou) for BMGF"
date: "Last updated on `r Sys.Date()`. DRAFT, DO NOT USE OR CITE."
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    self_contained: no
    toc: yes
    toc_depth: 2
    toc_float: yes
csl: apa.csl
link-citations: yes
nocite: |
  @aasr_2016, @alvarez2014typology, @jayne2015agdev, @hazell2013urban, @douillet2014developing, @jordan2005eth, @omamo2006strategic, @bacou2015ethseg, @omamo2006strategic, @benin2016agricultural, @willy2015adaptation, @jayne2015africafarmland, @diao2017ghana
css: css/fix.css
subtitle: A multi-scale and cross-time framework
bibliography: biblio.bib
---

--------------------------------------------------------------------------------------

```{r setup, echo=FALSE}

opts_chunk$set(comment=NA, warning=F, message=F, fig.width=6, fig.height=3, fig.path="../docs/fig/", base.url="../docs", dpi=300, out.height="340px")

library(data.table)
library(rhandsontable)
library(jsonlite)
library(knitr)
library(ggplot2)
library(scales)
library(cowplot)

load("../tmp/2017-agra-aasr.RData")

```


```{r, eval=FALSE}

library(data.table)
library(foreign)
library(stringr)
library(rhandsontable)
library(jsonlite)

setwd("~/Projects/2017-agra-aasr")
load("./tmp/2017-agra-aasr.RData")

#####################################################################################
# Helper - Construct variable summary
summaryTable <- function(dt) {
  
  dt.lbl <- data.table(
    varCode=names(dt),
    varLabel=attr(dt, "var.labels")
  )  
  tmp <- as.data.table(summary(dt))
  tmp[, V1 := 1:7]
  tmp <- dcast(tmp, V2~V1)
  setnames(tmp, c("varCode", "Min.", "1st Qu.", "Median", "Mean", "3rd Qu.", "Max.", "NA's"))
  tmp[, varCode := str_trim(varCode)]
  
  setkey(tmp, varCode)
  setkey(dt.lbl, varCode)
  dt.lbl <- tmp[dt.lbl]
  dt.lbl <- dt.lbl[names(dt)]
  
  dt.lbl[, `Hist.` := sapply(dt, function(x) ifelse(class(x)=="numeric", toJSON(list(values=hist(x, plot=FALSE)$counts)), toJSON(NA)))]
  
  setcolorder(dt.lbl, c(1,9,10,2:8))
  
  return(dt.lbl)
}

#####################################################################################
# Helper - NA to Zero
nona <- function(x) ifelse(is.na(x), 0, x)
#####################################################################################

# Load dataset #1 (variables extracted for the Poverty, Land, Climate paper)
hh1 <- read.dta("./tmp/Final_SSA_hhPOV_ 6 Apr 2016.12.dta")
hh.dim <- list(hh1=dim(hh1))

# Show summaries
hh1.lbl <- summaryTable(hh1)
hh1 <- data.table(hh1)

# List surveys/years included in this set
dt1.sum <- hh1[, .(
  Regions=uniqueN(svyL1Cd), 
  Districts=uniqueN(paste(svyL1Cd, svyL2Cd)), 
  Obs=.N), keyby=.(ISO3, Year=as.integer(year))]
dt1sum <- rhandsontable(dt1.sum, rowHeaders=NULL, height=600, width="auto")
rm(hh1)

# Describe variables
dt1var <- rhandsontable(hh1.lbl, rowHeaders=NULL, height=600, width="auto") %>%
  hot_col("Hist.", renderer=htmlwidgets::JS("renderSparkline")) %>%
  hot_cols(fixedColumnsLeft=1)

# Load dataset #2 (HarvestChoice Ag Snapshots)
hh2 <- read.dta("./tmp/Combined_Regdemovars13.12.dta")
hh.dim$hh2 <- dim(hh2)

# Summarize
hh2.lbl <- summaryTable(hh2)
hh2 <- data.table(hh2)

# List surveys/years included in this set
dt2.sum <- hh2[, .(
  Regions=uniqueN(svyL1Cd), 
  Obs=.N), keyby=.(ISO3, Year=as.integer(year))]
dt2sum <- rhandsontable(dt2.sum, rowHeaders=NULL, height=600, width="auto")
rm(hh2)

# Describe variables
dt2var <- rhandsontable(hh2.lbl, rowHeaders=NULL, height=600, width="auto") %>%
  hot_col("Hist.", renderer=htmlwidgets::JS("renderSparkline")) %>%
  hot_cols(fixedColumnsLeft=1)

# Load dataset #3 (Beliyou's Resilience Study)
hh3 <- read.dta("./tmp/Combined_4_Mel.12.dta")
hh.dim$hh3 <- dim(hh3)

# Summarize
hh3.lbl <- summaryTable(hh3)
hh3 <- data.table(hh3)

# List surveys/years included in this set
dt3.sum <- hh3[, .(
  Regions=uniqueN(region), 
  Districts=uniqueN(paste(region, district)), 
  Obs=.N), keyby=.(ISO3, Year=as.integer(year), round)]
dt3sum <- rhandsontable(dt3.sum, rowHeaders=NULL, height=600, width="auto")
rm(hh3)

# Describe variables
dt3var <- rhandsontable(hh3.lbl[1:150], rowHeaders=NULL, height=600, width="auto") %>%
  hot_col("Hist.", renderer=htmlwidgets::JS("renderSparkline")) %>%
  hot_cols(fixedColumnsLeft=1)

# Load dataset #4 (SSA Poverty)
hh4 <- read.dta("./tmp/SSApoverty_Dist_forGWR.12.dta")
hh.dim$hh4 <- dim(hh4)

# Keep labels
hh4.lbl <- data.table(varCode=names(hh4), varLabel=attr(hh4, "var.labels"))

# Remove dummy vars
hh4 <- hh4[, !names(hh4) %like% "ctry"]
hh4 <- hh4[, !names(hh4) %like% "yr"]
hh4 <- hh4[, !names(hh4) %like% "fs"]
setkey(hh4.lbl, varCode)
hh4.lbl <- hh4.lbl[names(hh4)]
attr(hh4, "var.labels") <- hh4.lbl$varLabel

# Correct types
for (i in names(hh4)) if (class(hh4[[i]])=="numeric") hist(hh4[[i]], plot=F)
hh4[[i]] <- as.character(hh4[[i]])

# Summarize
hh4.lbl <- summaryTable(hh4)
hh4 <- data.table(hh4)

# List surveys/years included in this set
dt4.sum <- hh4[, .(
  Regions=uniqueN(svyL1Cd), 
  Districts=uniqueN(paste(svyL1Cd, svyL2Cd)), 
  Obs=.N), keyby=.(ISO3, Year=as.integer(year))]
dt4sum <- rhandsontable(dt4.sum, rowHeaders=NULL, height=600, width="auto")
rm(hh4)

# Describe variables
dt4var <- rhandsontable(hh4.lbl, rowHeaders=NULL, height=600, width="auto") %>%
  hot_col("Hist.", renderer=htmlwidgets::JS("renderSparkline")) %>%
  hot_cols(fixedColumnsLeft=1)


# Load GHA GLSS rounds (Eduardo)


```

# Background

This study is a prospective chapter in *AGRA Africa Agriculture Status Report (AASR) 2017*.

The overall objective of the AASR report is to [@aasr_cn_2017]:  
 
1. provide an overview of the smallholder farmers and how they have adapted to the challenges they face as economic actors; 
2. explore innovative strategies that can substantially raise the productivity and incomes of smallholder farmers; 
3. identify policies and programs that can support the movement of Africa’s farming systems from subsistence-oriented to market-oriented thriving businesses; 
4. identify the necessary conditions, appropriate technologies, and institutions that can propel and support smallholder agriculture businesses; 
5. examine the past and the present role of public and private sector investment in agriculture and the success factors that can be scaled up to accelerate transformation.  

# Method

The study should provide a context-setting chapter that attempts to characterize, scale, locate, point to prioritization of high-level smallholder commercialization strategies, opportunities and challenges. A proposed approach is to chracterize SHFs and frame business strategies within a 2-by-2 domain framework (low/high rainfed ag potential across low/high market access areas). This approach assumes that agricultural development and adaptation strategies are largely driven by pre-existing bio-physical and spatial conditions.

We propose then focusing on around half a dozen countries for which we have recent/accessible microdata (e.g. LSMS-ISA and maybe AGRA baseline surveys) to look more closely, in the same 2x2 domain framework, at specific farm household and macro characteristics to do two things:  

1. Apply some typology to distinguish between say “predominantly-subsistence” focused and “transitioning-commercial” smallholders  
2. Report on hh level variables that can provide insight into the scale of potential business development challenges and opportunities in each country. 

Key farm and household-level variables to look at may include:

* Holding size
* Income/consumption
* Access to inputs/extension
* Use of inputs
* Land tenure status
* Education
* Cell-phone ownership
* Cooperative/self-help group membership
* Access to credit, insurance
* Off-farm income
* ...

# Supporting Datasets

Many (unpublished and mostly country-level) studies have attempted to derive farmer characteristics and farm typologies across geospatial dimensions (see e.g. refs below). IFPRI in particular generated cross-country comparable household variables (derived from World Bank LSMS-ISA panels, Demographic and Health Surveys, and/or other large-scale household surveys and agricultural census).

## Cross-Country Harmonized Variables

Inventory and summarize the latest versions of IFPRI's harmonized variables. Some of these variables are also available (summarized) across districts and/or regions and/or gender.

### Dataset #1 (Poverty, Land, Climate paper)

This dataset contains `r hh.dim$hh1[2]` variables and `r hh.dim$hh1[1]` observations. The breakdown across countries and survey years is as follows, and variables are further described in the next table. Many of these variables are also documented in @azzarri2016poverty.

```{r}

dt1sum

```
      

```{r}

dt1var

```

### Dataset #2 (HarvestChoice Agricultural Snapshots)

My copy of the household-level file is corrupt (would need to contact IFPRI directly) but the variables are similar in the region-level file.

This dataset contains `r hh.dim$hh2[2]` variables. The breakdown across countries and survey years is as follows, and variables are further described in the next table.

```{r}

dt2sum

```


```{r}

dt2var

```


### Dataset #3 (Panels for Resilience Study)

This dataset contains `r hh.dim$hh3[2]` variables and `r hh.dim$hh3[1]`  observations. The breakdown across countries and survey years is as follows, and variables are further described in the next table.

```{r}

dt3sum

```

This dataset also includes over 2,000 constructed climatic variables (monthly SPEI, temperature, rainfall, PDSI, etc.). To save space they are not shown in the variable summary below.

```{r}

dt3var

```

### Dataset #4 (SSA Poverty Regressions)

This dataset contains `r hh.dim$hh4[2]` variables and `r hh.dim$hh4[1]` observations. The breakdown across countries and survey years is as follows, and variables are further described in the next table. This is a district-level dataset (IFPRI holds the hh-level variables).

```{r}

dt4sum

```

```{r}

dt4var

```

## Demographic and Health Surveys (harmonized)

IFPRI holds cross-country harmonized variables from the latest DHS. Complete metadata is in a [DHS Google Sheet](https://docs.google.com/spreadsheets/d/1v8DDLgi9lQbS4uKnxYPM83PYC90rijJvjKN4xAntKlE/edit#gid=916658631). We would need to request access to the CHILD and WOMAN recodes, I only have the STRATA summaries.


## Other Country-Level Panel Variables

### Ghana GLSS Rounds

(as needed). IFPRI/DSG holds 3 rounds (2005, 2008, 2012) of harmonized variables focused on wages and productivity trends.

### Nigeria Farm Segmentation Study

(as needed, used in the typology below)

# Typology of Farm Smallholdings

This section is an exploration of smallholdings and smallholder farmers (definition and characteristics) in Nigeria and Ethiopia.

## Nigeria

In the following we define **smallholding** as a farm with total cultivated area **less or equal to 4 ha**. We then look at the distributions of the following key variables. Note that all *value* variables have been generated by IFPRI using [FAO RIGA](http://www.fao.org/economic/riga/riga-database/en/) method.

* $farmarea$ farm size (incl. parcels rented out and fallows)
* $croparea$ cultivated area (annual)
* $cropsold$ annual value of crops and crop byproducts sold (per RIGA method)
  $$ cropsold=cropsold+agbyprodincimp-reimbursmtn-giftn $$  
* $lstocksold$ annual value of livestock products and byproducts sold  
  $$ lstocksold=livstrevgrossimp+livstbyprodimp $$  
* $agsales$ farm sales, i.e. combined value of crop, livestock, and fish products sold  
  $$ agsales=cropsold+lstocksold+fishsold $$  
* $agsalespc$ farm sales per adult equivalent  
  $$ agsalespc=\frac{agsales}{equiv} $$  
* $aggross$ farm income (includes value of own consumption, ag wages and ag rents)  
  $$ aggross=agsales+agrwge+farmrntimp+agrentimp+cropownimp $$  
* $totgross$ total gross income (incl. farm income, non-farm income, and transfers)  
  $$ totgross=aggross+nonagrwge+other+privtransfer+pubtransfer+self $$  
* $agshare$ share of farm income in total household income  
  $$ agshare=\frac{aggross}{totgross} $$  
* $cropsold\_sh$ commercialization rate for crops, defined as the value of crops and crop products sold over the value of annual crops produced (excluding perennial crops) (<u>note</u>: I am not sure where crop losses are accounted for in RIGA, need to check intermediary steps):  
  $$ cropsold\_sh = \frac{cropsold}{cropsold+cropownimp} $$  
* $TLU\_total$ and $TLU\_total\_imp$ tropical livestock units (combines all animals)  


```{r, eval=FALSE}

# Use ggplot2 for charts
#ggplotly(p)
theme_paper <- function(...) theme_fivethirtyeight(base_family="Roboto Condensed", base_size=8) +
  theme(plot.title=element_text(size=rel(1.2), face="plain"))

# Load and copy data extracts from the 2016 NGA Segmentation
e1 <- new.env()
setwd("~/Google Drive/2016-BMGF-Segmentation/NGA")
load("./temp/nga_bmgf_seg_1.RData", envir=e1)
setwd("~/Projects/2017-agra-aasr")

ghs <- e1$ghs
ghs.farm <- e1$farm
ghs.geo <- e1$geo12
rm(e1)

# SHF 4ha dummy `croparea_4ha`
ghs.farm[, croparea_4ha := factor(croparea <= 4, levels=c(T, F), labels=c("<= 4 ha", "> 4 ha"))]

# Merge into `ghs` (`hhid` are unique)
setkey(ghs, hhid)
setkey(ghs.farm, hhid)
ghs[ghs.farm, croparea := croparea]
ghs[ghs.farm, croparea_4ha := croparea_4ha]

summary(ghs$croparea_4ha)
# <= 4 ha  > 4 ha    NA's 
#    2847      94    1939 

ghs[is.na(croparea) & TLU_total > 0, .N]
# 142

# Commercialization rate for crops `cropsold_sh`
ghs[cropsold > 0, farm_hh := TRUE]
ghs[, cropsold_sh := NULL]
ghs[farm_hh==T, cropsold_sh := cropsold/(nona(cropsold)+nona(cropownimp))]
summary(ghs$cropsold_sh)
 #   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
 # 0.0000  0.0000  0.0007  0.1117  0.0098  1.0000    2000 

# Commercialization dummy `cropsold_any`
ghs[, cropsold_any := NULL]
ghs[farm_hh==T, cropsold_any := factor(cropsold > 0, levels=c(F, T), labels=c("SSF", "TSF"))]
summary(ghs$cropsold_any)

# Define 2-stage stratified survey design (use most recent GHS wave only)
ghs.svy <- svydesign(~hhid, strata=~zone+rural, weights=~wt_wave2, 
  data=ghs[!is.na(wt_wave2)])
ghs.farm.svy <- svydesign(~hhid, strata=~zone+sector, weights=~wt_wave2,
  data=ghs.farm[!is.na(wt_wave2)])

summary(ghs.svy)
# Stratified Independent Sampling design (with replacement)
# svydesign(~hhid, strata = ~zone + rural, weights = ~wt_wave2, 
#     data = ghs[!is.na(wt_wave2)])
# Probabilities:
#      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
# 0.0000239 0.0001235 0.0001892 0.0002150 0.0002699 0.0014700 
# Stratum Sizes: 
#            north central north east north west south east south south south west
# obs                  798        754        890        791         786        848
# design.PSU           798        754        890        791         786        848
# actual.PSU           798        754        890        791         786        848

# Subset survey sample to farm households
ghs.svy.farm <- subset(ghs.svy, farm_hh==T)
# Subset survey sample to only SHF
ghs.svy.shf <- subset(ghs.svy, croparea <= 4)

# Verify sampling design (e.g. total population)
(svytotal(~hhsize, ghs.svy, na.rm=T))/1E6
#         total      SE
# hhsize 187.88 2248776

svytotal(~farm_hh, ghs.svy, na.rm=T)
#                 total     SE
# farm_hhFALSE 13925359 327744
# farm_hhTRUE  18810445 279728

svymean(~farm_hh, ghs.svy, na.rm=T)
#                 mean     SE
# farm_hhFALSE 0.42539 0.0083
# farm_hhTRUE  0.57461 0.0083

svymean(~croparea_4ha, ghs.svy.farm, na.rm=T)
#                         mean     SE
# croparea_4ha<= 4 ha 0.971939 0.0034
# croparea_4ha> 4 ha  0.028061 0.0034

svytotal(~hhsize, ghs.svy.shf, na.rm=T)
#            total      SE
# hhsize 106640203 1923843

svymean(~cropsold_sh, ghs.svy.farm, na.rm=T)
#                mean     SE
# cropsold_sh 0.12218 0.0064

svyby(~cropsold_sh, ~croparea_4ha, ghs.svy.farm, svymean, na.rm=T)
#         croparea_4ha cropsold_sh          se
# <= 4 ha      <= 4 ha   0.1220218 0.006486836
# > 4 ha        > 4 ha   0.1768049 0.049141108

svyby(~cropsold_sh, ~croparea_4ha, ghs.svy.farm, svyquantile, quantiles=.5, ci=T, na.rm=T)*100
#         croparea_4ha cropsold_sh          se
# <= 4 ha           NA   0.0771759 0.009096578
# > 4 ha            NA   0.2983544 0.297562013

# Quick compare `farmarea` and `croparea` 
par(mfrow=c(1,3))
svyhist(~farmarea, ghs.svy.farm, main="Farm Area (ha)", xlim=c(0,10))
lines(svysmooth(~farmarea, ghs.svy.farm, bandwidth=1), lwd=1, col="red")
svyhist(~croparea, ghs.svy.farm, main="Cultivated Area (ha)", xlim=c(0,10))
svyboxplot(farmarea~croparea_4ha, ghs.svy.farm, main="Farm Area (ha)")

# croparea
p1 <- ggplot(data=ghs[farm_hh==T], aes(x=croparea, weight=wt_wave2)) + 
  geom_histogram(alpha=.6, binwidth=.25, color=alpha("white", .5)) +
  geom_freqpoly(color="red", alpha=.6) +
  scale_x_continuous(limits=c(0,7)) +
  scale_y_continuous(label=unit_format(unit="M", scale=1E-6)) +
  ggtitle("Cultivated Area (ha), Nigeria 2012", 
    "Counts of Farm Households (weighted)") +
  theme_paper()

p2 <- ggplot(data=ghs[farm_hh==T], aes(croparea, weight=wt_wave2)) + 
  stat_ecdf(geom="step", pad=F, alpha=.6) +
  geom_hline(yintercept=.5, col="red", linetype=2) +
  scale_x_continuous(limits=c(0,7)) +
  ggtitle("Cultivated Area (ha), Nigeria 2012", 
    "Cumulative Distribution of Farm Households (weighted)") +  
  theme_paper()

# cropsold_sh
p3 <- ggplot(data=ghs[!is.na(croparea_4ha)], aes(cropsold_sh*100, weight=wt_wave2)) + 
  geom_histogram(alpha=.7, color=alpha("white", .5)) +
  geom_freqpoly(color="red", alpha=.6, binwidth=10) +
  facet_wrap(~croparea_4ha, scales="free") +
  scale_x_continuous(limits=c(-2,100)) +
  scale_y_continuous(label=unit_format(unit="M", scale=1E-6)) +
  ggtitle("Crop Commercialization (percent)",
    "Counts of Farm Households (weighted)") +
  theme_paper()

p4 <- ggplot(data=ghs[farm_hh==T & !is.na(croparea)], aes(cropsold_sh*100, weight=wt_wave2)) + 
  stat_ecdf(geom="step", alpha=.6) +
  geom_hline(aes(yintercept=.5), col="red", linetype=2) +   
  facet_wrap(~croparea_4ha, scales="free") +
  scale_x_continuous(limits=c(0,20)) +
  ggtitle("Crop Commercialization (percent)",
    "Cumulative Distribution of Farm Households (weighted)") +
  theme_paper()

# Estimated deciles of `cropsold_sh` for smallholders
t1 <- rbind(
  svyquantile(~croparea, ghs.svy.farm, 2:9/10, na.rm=T),
  svyquantile(~cropsold_sh, ghs.svy.shf, 2:9/10, na.rm=T)*100,
  svyquantile(~cropsold_sh, subset(ghs.svy.farm, croparea_4ha=="> 4 ha"), 2:9/10, na.rm=T)*100)
rownames(t1) <- c(
  "Cultivated Area (ha)", 
  "Crop Commercialization (percent, <= 4 ha)",
  "Crop Commercialization (percent, > 4 ha)")

# Show proportions
t2 <- svytable(~croparea_4ha+cropsold_any, ghs.svy.farm, Ntotal=100, round=2)

# TODO Estimated deciles of other variables for smallholders
t3 <- svyby(~farmarea+lstocksold+TLU_total_imp+agshare+aggross, 
    ~cropsold_any, ghs.svy.shf, svyquantile, 2:9/10, ci=T, na.rm=T)

# farmarea
par(mfrow=c(1,2))
svyhist(~farmarea, ghs.svy.shf, main="Farm Size (ha)", xlab="ha")
lines(svysmooth(~croparea, ghs.svy.shf, bandwidth=1), lwd=1, col="red")
plot(svycdf(~farmarea, ghs.svy.shf), main="Farm Size (ha)", xlab="ha")
abline(h=0.5, lty=2, col="red")
abline(h=0, lty=2, col="grey70")
abline(h=1, lty=2, col="grey70")

# lstocksold
par(mfrow=c(1,2))
svyhist(~lstocksold, ghs.svy.shf, main="Sales of Livestock Products", xlab="LCU")
#lines(svysmooth(~lstocksold, ghs.svy.shf), lwd=1, col="red")
plot(svycdf(~lstocksold, ghs.svy.shf), main="Sales of Livestock Products", xlab="LCU")
abline(h=0.5, lty=2, col="red")
abline(h=0, lty=2, col="grey70")
abline(h=1, lty=2, col="grey70")

# TLU_total
par(mfrow=c(1,2))
svyhist(~TLU_total_imp, ghs.svy.shf, main="Total TLU", xlab="", breaks=seq(0,251,5), xlim=c(0,50))
#lines(svysmooth(~TLU_total, ghs.svy.shf), lwd=1, col="red")
plot(svycdf(~TLU_total_imp, ghs.svy.shf), main="Total TLU", xlab="")
abline(h=0.5, lty=2, col="red")
abline(h=0, lty=2, col="grey70")
abline(h=1, lty=2, col="grey70")

# agshare
par(mfrow=c(1,2))
svyhist(~agshare, ghs.svy.shf, main="Share of Farm Income", xlab="share")
lines(svysmooth(~agshare, ghs.svy.shf, bandwidth=0.1), lwd=1, col="red")
plot(svycdf(~agshare, ghs.svy.shf), main="Share of Farm Income", xlab="share")
abline(h=0.5, lty=2, col="red")
abline(h=0, lty=2, col="grey70")
abline(h=1, lty=2, col="grey70")

# Gross ag income
tmp <- ghs[!is.na(wt_wave2) & farmarea<=4, sum(aggross*wt_wave2, na.rm=T)/1e+9, keyby=croparea <= 4]

# Livestock TLU
tmp <- ghs[!is.na(wt_wave2), sum(TLU_total_imp*wt_wave2, na.rm=T), keyby=croparea <= 4]

# Cultivated area
tmp <- farm[!is.na(wt_wave2), sum(croparea*wt_wave2, na.rm=T), keyby=croparea <= 4]

# Demographics
tmp <- ghs[!is.na(wt_wave2), lapply(.SD, weightedMean, wt_wave2, na.rm=T),
  .SDcols=c("wt_wave2", "hhsize", "agehead", "lithead", "eduyears", "numchildren",
    "equiv", "females", "males", "sh_ed_none", "sh_ed_prim", "sh_ed_high"),
  keyby=croparea <= 4][, wt_wave2 := NULL]

# Population
tmp <- ghs[!is.na(wt_wave2), sum(wt_wave2*hhsize, na.rm=T), keyby=croparea <= 4]

# Other farms statistics
tmp <- ghs[!is.na(wt_wave2) & farm_hh==T, .(
    f2malehh_tot=sum(femhead*wt_wave2, na.rm=T),
    malehh_tot=sum(-(femhead-1)*wt_wave2, na.rm=T),
    femalehh=weightedMean(femhead, wt_wave2, na.rm=T),
    hasland=weighted.mean(farmarea>0, wt_wave2, na.rm=T),
    farmarea=weightedMean(hectares_1_hh_farmer, wt_wave2, na.rm=T),
    farmarea_med=weightedMedian(hectares_1_hh_farmer, wt_wave2, na.rm=T)
  ), keyby=croparea <= 4]

tmp <- farm[, .(
    farmslive_tot=sum(farmslive*wt_wave2, na.rm=T),
    farmslive=weightedMean(farmslive, wt_wave2, na.rm=T),
    intens_idx2=weightedMean(intens_idx2, wt_wave2, na.rm=T),
    intens_idx2_med=weightedMedian(intens_idx2, wt_wave2, na.rm=T)
  ), keyby=croparea <= 4]

# Livestock
tmp <- ghs[!is.na(wt_wave2) & totgross > 0, .(
    TLU_total=sum(TLU_total, wt_wave2, na.rm=T),
    TLU_hh=weightedMean(TLU_total, wt_wave2, na.rm=T),
    TLU_hh_imp=weightedMean(TLU_total_imp, wt_wave2, na.rm=T)
  ), keyby=croparea <= 4][, wt_wave2 := NULL]

# Income
tmp <- ghs[!is.na(wt_wave2) & farm_hh==T, lapply(.SD, weightedMean, wt_wave2, na.rm=T),
  .SDcols=c("wt_wave2", "agsales", "aggross", "totgross", "agshare"),
  keyby=croparea <= 4][, wt_wave2 := NULL]

# Input uses
tmp <- farm[, lapply(.SD, weightedMean, wt_wave2, na.rm=T),
  .SDcols=c("wt_wave2", "parcels", "sh_chempest", "sh_chemherb", "sh_fertorg",
    "sh_fertinorg", "sh_seedp", "tractorown_farms"),
  keyby=croparea <= 4][, wt_wave2 := NULL]

# Poverty
vars <- c("weight", names(ppp12)[names(ppp12) %like% "ppp"])
tmp <- ppp12[, lapply(.SD, weightedMean, weight, na.rm=T), .SDcols=vars,
  keyby=croparea <= 4][, weight := NULL]

``` 

Below are the 2012 estimated distributions of cultivated area ($croparea$) and crop commercialization rate ($cropsold\_sh$) across all Nigerian *farm* households.

```{r}

plot_grid(p1, p2)
p3; p4
pander(t1, digits=2, caption="Quantiles of Farm Households (weighted)")

```

Using the **<= 4 ha** smallholding definition above, we estimate as of 2012:

* there are **33M** households in Nigeria
* **57.5%** (**18.7M**) generate a revenue from farming (wages, rents, crops, livestock, and/or fish)
* **97%** (**16M**) of farm holdings are *small* 
* corresponding to a beneficiary population of **107M**
* crop commercialization is low at **12.2%** for smallholdings (below 4 ha) and **17.7%** for larger holdings (over 4 ha) on average. Median rates are much smaller however with **0.07%** for smallholdings and **0.3%** for larger holdings.

Within the subsample of *small* farm holdings we further distinguish between the following 2 categories of households:

* **<u>Subsistence</u> smallholder (SSF)**: farms with only own production
* **<u>Transition</u> smallholder (TSF)**: farms with any value of crop sales
* **<u>Commercial</u> smallholder**: [not used here]

Subsistence and transition farm holdings are characterized as follows.

```{r}

pander(t2, caption="Proportions of Farm Holdings (percent)")

```



## Ethiopia 


# Quadrant Classification

## Nigeria

[TBD]

For documentation purposes below are code snippets from the 2016 Farmer Segmentation for Nigeria (definitions and characterization of quadrants and livelihood zones).


```{r, eval=FALSE}

#####################################################################################
# 2016.05.03 Quadrant Definitions across Livelihood Zones (from Diemuth 2016.04.06)
#####################################################################################
# We need to add a new segment vars to all key micro datasets, starting with GHS.
# Diemuth provided latest quadrant definitions.
#
#  - [country]_agpotallclass_1km.tif – Agricultural potential raster with 1km cell
# resolution and same extent as ethtt_1km100khr. Created from clipping sub-Saharan Africa
# Agricultural Potential 5 minute grid vector layer from FAO & IIASA, 2007. For the
# 2x2 segmented data, 5-6 values were considered high, 1-4 low and -809-0 were
# unsuitable and -997 were water.
# -997 = Water
# -809 = Protected Areas
# -807 = Urban Areas
# -805 = Irrigated Areas
# -801 = Forest
# 0 = Land not suited for agriculture
# 1 = Land very poorly suited for pasture and at best poorly suited for rainfed crops
# 2 = Land poorly suited for pasture and at best poorly suited for rainfed crops
# 3 = Lands suited for pasture and at best poorly suited for rainfed crops
# 4 = Land suited for rainfed crops and pasture possible
# 5 = Land well suited for rainfed crops and pasture possible
# 6 = Prime land suited for rainfed crops and pasture possible
#
# - [country]_tt1km100khr_4hr.tif – Classified travel time raster with a 4 hr threshold,
# HarvestChoice, 2015
# 100 – travel time greater than 4 hours, lo access
# 200 – travel time less than or equal to 4 hours, high access

# Load the 2 rasters and classify LGAs
qd.agpot <- raster("./maps/quadrant/nga_agpotallclass_1km.tif")
qd.tt100k <- raster("./maps/quadrant/nga_tt1km100khr_4hr.tif")
proj4string(qd.agpot)
proj4string(qd.tt100k)
proj4string(geo12.pts)
unique(qd.agpot)
#  [1] -997 -809 -807 -805 -801    0    1    2    3    4    5    6
summary(qd.tt100k)
#         nga_tt1km100khr_4hr
# Min.                    100
# 1st Qu.                 100
# Median                  200
# 3rd Qu.                 200
# Max.                    200
# NA's                      0
# Note that raster tt100k is already classified.

qd.agpot.lbl <- c(
"water",
"protected area",
"urban area",
"irrigated area",
"forest",
"land not suited for agriculture",
"land very poorly suited for pasture and at best poorly suited for rainfed crops",
"land poorly suited for pasture and at best poorly suited for rainfed crops",
"land suited for pasture and at best poorly suited for rainfed crops",
"land suited for rainfed crops and pasture possible ",
"land well suited for rainfed crops and pasture possible",
"prime land suited for rainfed crops and pasture possible")

qd.agpot.lbl <- data.table(varCode=unique(qd.agpot), varLabel=qd.agpot.lbl)

# Intersect with GHS coords
tmp <- extract(qd.agpot, geo12.pts)
tmp <- data.table(hhid=geo12.pts$hhid, qd.agpot=tmp)
tmp[, qd.agpot := factor(qd.agpot, levels=qd.agpot.lbl$varCode, labels=qd.agpot.lbl$varLabel)]
tmp1 <- extract(qd.tt100k, geo12.pts)
tmp[, qd.tt100k := tmp1]
tmp[, qd.tt100k := factor(qd.tt100k, levels=c(100, 200), labels=c("ML", "MH"))]
setkey(tmp, hhid)
setkey(geo12, hhid)
geo12 <- tmp[geo12]
rm(tmp, tmp1)

# Classify hhlds across quadrants
# Rename old segment var to avoid confusion
setnames(geo12, c("qd.agpot", "qd.tt100k"), c("qd_agpot", "qd_tt100k"))
setnames(geo12, "seg_quad", "seg_quad_old")
setnames(ghs, "seg_quad", "seg_quad_old")
setnames(ppp12, "seg_quad", "seg_quad_old")
setnames(inc12, "seg_quad", "seg_quad_old")
setnames(farm, "seg_quad", "seg_quad_old")

geo12[qd_agpot %in% qd.agpot.lbl$varLabel[1:6], qd_agpot_clas := "AU"]
geo12[qd_agpot %in% qd.agpot.lbl$varLabel[7:10], qd_agpot_clas := "AL"]
geo12[qd_agpot %in% qd.agpot.lbl$varLabel[11:12], qd_agpot_clas := "AH"]
summary(factor(geo12$qd_agpot_clas))
#   AH   AL   AU NA's
# 1968 1490 1323  117

summary(factor(geo12$qd_tt100k))
#   ML   MH NA's
#  750 4051   97

# Impute missing hhld coords with LGA means
# Compute LGA means from `g2` map (using dominant class)
geo12[is.na(qd_agpot_clas), .N, by=.(adm1_nm, adm2_nm)]
# => missing records in 58 LGAs

tmp <- geo12[!is.na(qd_agpot_clas), .(
    qd_agpot_clas=modal(qd_agpot_clas, na.rm=T),
    qd_tt100k=modal(qd_tt100k, na.rm=T)
), keyby=.(adm1_nm, adm2_nm)]

setnames(tmp, 3:4, c("qd_agpot_clas_imp", "qd_tt100k_imp"))
setkey(geo12, adm1_nm, adm2_nm)
geo12 <- tmp[geo12]

geo12[is.na(qd_agpot_clas), qd_agpot_clas := qd_agpot_clas_imp]
geo12[is.na(qd_tt100k), qd_tt100k := qd_tt100k_imp]

geo12[is.na(qd_agpot_clas), .N, by=.(adm1_nm, adm2_nm)]
#    adm1_nm adm2_nm  N
# 1:  Rivers   Bonny 10
geo12[is.na(qd_tt100k), .N, by=.(adm1_nm, adm2_nm)]
# Empty data.table (0 rows) of 3 cols: adm1_nm,adm2_nm,N
# => only 10 missing records in Bonny

# What is the dominant agpot in Bonny? Extract all LGAs for re-use.
tmp <- extract(qd.agpot, g2, fun=modal, na.rm=T)
g2$qd_agpot <- tmp
# Note that we already have median 100k travel time across LGAs in `g2$mkt100k`
# though I'm not sure it's the same source as Diemuth/Stan

# load Joe's latest travel times
tt100k <- dt[, .SD, .SDcols=c("CELL5M", "X", "Y", "tt10_100k")]
rm(dt)
tt100k <- SpatialPixelsDataFrame(tt100k[, .(X,Y)], data.frame(tt100k))
proj4string(tt100k) <- CRS("+init=epsg:4326")
tt100k <- raster(tt100k, layer="tt10_100k")
tmp <- extract(tt100k, g2, fun=median, na.rm=T)
g2$qd_tt100k <- tmp
# Export for mapping
tt100k <- crop(tt100k, g2)
tt100k <- mask(tt100k, g2)
writeRaster(tt100k, "./maps/markets/tt100k.tif")
rm(tmp)

# What is Bonny?
g2[g2$adm2_nm=="Bonny", "qd_agpot"]
# => -997, so AU
geo12[is.na(qd_agpot_clas), qd_agpot_clas := "AU"]
summary(factor(geo12$qd_agpot_clas))
#   AH   AL   AU
# 1997 1530 1371

# Make final quadrant classification for GHS
geo12[, seg_quad := paste0(qd_tt100k, qd_agpot_clas)]
geo12[, unique(seg_quad)]
# [1] "MHAU" "MHAL" "MHAH" "MLAH" "MLAL" "MLAU"
geo12[, seg_quad := ordered(seg_quad, levels=c("MLAU", "MLAL", "MLAH", "MHAU", "MHAL", "MHAH"))]

# Merge quadrants into `ghs`, `farm` and `ppp12`
setkey(geo12, hhid)
setkey(ghs, hhid)
setkey(farm, hhid)
setkey(ppp12, hhid)
ghs$seg_quad <- geo12[ghs][, seg_quad]
farm$seg_quad <- geo12[farm][, seg_quad]
ppp12$seg_quad <- geo12[ppp12][, seg_quad]

# Re-run summary tables
# => done

#####################################################################################
# Crop preferences across quadrants/zones - GHS
#####################################################################################

# Note that Cleo generated the hh-level vars and Eduardo estimated state-level vars
ghs.plot <- read.dta("./data/NGA-GHS/NGA_GHS_Indicator_plot_2012.dta")
ghs.plot <- data.table(ghs.plot)

# Merge in segmentation vars
setkey(geo12, hhid)
setkey(ghs.crop, hhid)
setkey(ghs.plot, hhid)
ghs.crop$seg_quad <- geo12[ghs.crop][, seg_quad]
ghs.plot$seg_quad <- geo12[ghs.plot][, seg_quad]
ghs.crop$seg_lvl_6 <- geo12[ghs.crop][, seg_lvl_6]
ghs.plot$seg_lvl_6 <- geo12[ghs.plot][, seg_lvl_6]

# Share of female plot managers
tmp <- ghs.plot[, .N, by=.(hhid, wt_w2v1, manager, state, gender)]

tmp <- ghs.crop[, .(
    num_fem_mgr=sum(num_fem_mgr*wt_wave2, na.rm=T)/sum(num_hh_mgr*wt_wave2, na.rm=T),
    fem_mgr=weighted.mean(num_fem_mgr>0, wt_wave2, na.rm=T),
    fem_earn=weighted.mean(fem_earn, wt_wave2, na.rm=T)
  ), keyby=seg_lvl_6]
tmp <- ghs.crop[, .(
    num_fem_mgr=sum(num_fem_mgr*wt_wave2, na.rm=T)/sum(num_hh_mgr*wt_wave2, na.rm=T),
    fem_mgr=weighted.mean(num_fem_mgr>0, wt_wave2, na.rm=T),
    fem_earn=weighted.mean(fem_earn, wt_wave2, na.rm=T)
  ), keyby=seg_quad]
tmp <- ghs.crop[, .(
    num_fem_mgr=sum(num_fem_mgr*wt_wave2, na.rm=T)/sum(num_hh_mgr*wt_wave2, na.rm=T),
    fem_mgr=weighted.mean(num_fem_mgr>0, wt_wave2, na.rm=T),
    fem_earn=weighted.mean(fem_earn, wt_wave2, na.rm=T))]


# Share of female-managed plots
tmp <- ghs.plot[, .(femplotmgr=weighted.mean(gender=="female", wt_w2v1, na.rm=T)),
  keyby=seg_lvl_6]
tmp <- ghs.plot[, .(femplotmgr=weighted.mean(gender=="female", wt_w2v1, na.rm=T)),
  keyby=seg_quad]
tmp <- ghs.plot[, .(femplotmgr=weighted.mean(gender=="female", wt_w2v1, na.rm=T))]


# TODO Area of female-managed plots under each crop
tmp <- ghs.plot[, lapply(.SD, sum, na.rm=T),
  keyby=.(hhid, wt_w2v1, state, gender), .SDcols=96:147]
tmp <- tmp[, lapply(.SD, function(x) sum(x*wt_w2v1, na.rm=T)),
  keyby=.(state, gender), .SDcols=c(2, 5:56)]
tmp[, wt_w2v1 := NULL]
tmp <- melt(tmp, id.vars=1:2)
tmp[, variable := str_replace(variable, "area_", "")]
tmp <- tmp[!is.na(gender)]

# Proportion of female-managed plots by crop
tmp <- melt(ghs.plot,
  id.vars=c("seg_quad", "seg_lvl_6", "gender", "wt_w2v1"),
  measure.vars=11:147)
tmp[value=="yes", value := "1"]
tmp[value=="no", value := "0"]
tmp[, value := as.numeric(value)]
tmp <- tmp[, lapply(.SD, weighted.mean, wt_w2v1), keyby=.(seg_lvl_6, gender, variable)]

# TODO Additional production stats
# TODO Also check on Sara's harmonized farm management stats

```



## Ethiopia

[TBD]

# References

Note that some of these references are unpublished materials, do not cite.

```{r, eval=FALSE, include=FALSE}

# Save workspace
rm(i, x, tmp)
save.image("./tmp/2017-agra-aasr.RData")

# Render
rmarkdown::render("./R/2017-agra-aasr.Rmd", output_file="index.html", output_dir="./docs")

```
