# Agricultural Potential

## Nigeria

[TBD]

For documentation purposes below are code snippets from the 2016 Farmer Segmentation for Nigeria (definitions and characterization of low-high quadrants and livelihood zones).


```{r nga-quad, eval=FALSE}

#####################################################################################
# 2016.05.03 Quadrant Definitions across Livelihood Zones (from Diemuth 2016.04.06)
#####################################################################################
# We need to add a new segment vars to all key micro datasets, starting with GHS.
# Diemuth provided latest quadrant definitions.
#
#  - [country]_agpotallclass_1km.tif – Agricultural potential raster with 1km cell
# resolution and same extent as ethtt_1km100khr. Created from clipping sub-Saharan Africa
# Agricultural Potential 5 minute grid vector layer from FAO & IIASA, 2007. For the
# 2x2 segmented data, 5-6 values were considered high, 1-4 low and -809-0 were
# unsuitable and -997 were water.
# -997 = Water
# -809 = Protected Areas
# -807 = Urban Areas
# -805 = Irrigated Areas
# -801 = Forest
# 0 = Land not suited for agriculture
# 1 = Land very poorly suited for pasture and at best poorly suited for rainfed crops
# 2 = Land poorly suited for pasture and at best poorly suited for rainfed crops
# 3 = Lands suited for pasture and at best poorly suited for rainfed crops
# 4 = Land suited for rainfed crops and pasture possible
# 5 = Land well suited for rainfed crops and pasture possible
# 6 = Prime land suited for rainfed crops and pasture possible
#
# - [country]_tt1km100khr_4hr.tif – Classified travel time raster with a 4 hr threshold,
# HarvestChoice, 2015
# 100 – travel time greater than 4 hours, lo access
# 200 – travel time less than or equal to 4 hours, high access

library(raster)
library(data.table)
library(viridis)

setwd("~/Google Drive/2016-BMGF-Segmentation/NGA")

# Load the 2 rasters and classify LGAs
qd.agpot <- raster("./maps/quadrant/nga_agpotallclass_1km.tif")
qd.tt100k <- raster("./maps/quadrant/nga_tt1km100khr_4hr.tif")
proj4string(qd.agpot)
proj4string(qd.tt100k)
proj4string(geo12.pts)
unique(qd.agpot)
#  [1] -997 -809 -807 -805 -801    0    1    2    3    4    5    6
summary(qd.tt100k)
#         nga_tt1km100khr_4hr
# Min.                    100
# 1st Qu.                 100
# Median                  200
# 3rd Qu.                 200
# Max.                    200
# NA's                      0
# Note that raster tt100k is already classified.

qd.agpot.lbl <- c(
  "water",
  "protected area",
  "urban area",
  "irrigated area",
  "forest",
  "land not suited for agriculture",
  "land very poorly suited for pasture and at best poorly suited for rainfed crops",
  "land poorly suited for pasture and at best poorly suited for rainfed crops",
  "land suited for pasture and at best poorly suited for rainfed crops",
  "land suited for rainfed crops and pasture possible ",
  "land well suited for rainfed crops and pasture possible",
  "prime land suited for rainfed crops and pasture possible")

qd.agpot.lbl <- data.table(ID=1:12, code=unique(qd.agpot), label=qd.agpot.lbl)

# Plot agpot layer
spplot(qd.agpot, at=unique(qd.agpot), col.regions=viridis(12), colorkey=list(at=1:12, labels=as.character(unique(qd.agpot))))


# Intersect with GHS coords
tmp <- extract(qd.agpot, geo12.pts)
tmp <- data.table(hhid=geo12.pts$hhid, qd.agpot=tmp)
tmp[, qd.agpot := factor(qd.agpot, levels=qd.agpot.lbl$varCode, labels=qd.agpot.lbl$varLabel)]
tmp1 <- extract(qd.tt100k, geo12.pts)
tmp[, qd.tt100k := tmp1]
tmp[, qd.tt100k := factor(qd.tt100k, levels=c(100, 200), labels=c("ML", "MH"))]
setkey(tmp, hhid)
setkey(geo12, hhid)
geo12 <- tmp[geo12]
rm(tmp, tmp1)

# Classify hhlds across quadrants
# Rename old segment var to avoid confusion
setnames(geo12, c("qd.agpot", "qd.tt100k"), c("qd_agpot", "qd_tt100k"))
setnames(geo12, "seg_quad", "seg_quad_old")
setnames(ghs, "seg_quad", "seg_quad_old")
setnames(ppp12, "seg_quad", "seg_quad_old")
setnames(inc12, "seg_quad", "seg_quad_old")
setnames(farm, "seg_quad", "seg_quad_old")

geo12[qd_agpot %in% qd.agpot.lbl$varLabel[1:6], qd_agpot_clas := "AU"]
geo12[qd_agpot %in% qd.agpot.lbl$varLabel[7:10], qd_agpot_clas := "AL"]
geo12[qd_agpot %in% qd.agpot.lbl$varLabel[11:12], qd_agpot_clas := "AH"]
summary(factor(geo12$qd_agpot_clas))
#   AH   AL   AU NA's
# 1968 1490 1323  117

summary(factor(geo12$qd_tt100k))
#   ML   MH NA's
#  750 4051   97

# Impute missing hhld coords with LGA means
# Compute LGA means from `g2` map (using dominant class)
geo12[is.na(qd_agpot_clas), .N, by=.(adm1_nm, adm2_nm)]
# => missing records in 58 LGAs

tmp <- geo12[!is.na(qd_agpot_clas), .(
  qd_agpot_clas=modal(qd_agpot_clas, na.rm=T),
  qd_tt100k=modal(qd_tt100k, na.rm=T)
), keyby=.(adm1_nm, adm2_nm)]

setnames(tmp, 3:4, c("qd_agpot_clas_imp", "qd_tt100k_imp"))
setkey(geo12, adm1_nm, adm2_nm)
geo12 <- tmp[geo12]

geo12[is.na(qd_agpot_clas), qd_agpot_clas := qd_agpot_clas_imp]
geo12[is.na(qd_tt100k), qd_tt100k := qd_tt100k_imp]

geo12[is.na(qd_agpot_clas), .N, by=.(adm1_nm, adm2_nm)]
#    adm1_nm adm2_nm  N
# 1:  Rivers   Bonny 10
geo12[is.na(qd_tt100k), .N, by=.(adm1_nm, adm2_nm)]
# Empty data.table (0 rows) of 3 cols: adm1_nm,adm2_nm,N
# => only 10 missing records in Bonny

# What is the dominant agpot in Bonny? Extract all LGAs for re-use.
tmp <- extract(qd.agpot, g2, fun=modal, na.rm=T)
g2$qd_agpot <- tmp
# Note that we already have median 100k travel time across LGAs in `g2$mkt100k`
# though I'm not sure it's the same source as Diemuth/Stan

# load Joe's latest travel times
tt100k <- dt[, .SD, .SDcols=c("CELL5M", "X", "Y", "tt10_100k")]
rm(dt)
tt100k <- SpatialPixelsDataFrame(tt100k[, .(X,Y)], data.frame(tt100k))
proj4string(tt100k) <- CRS("+init=epsg:4326")
tt100k <- raster(tt100k, layer="tt10_100k")
tmp <- extract(tt100k, g2, fun=median, na.rm=T)
g2$qd_tt100k <- tmp
# Export for mapping
tt100k <- crop(tt100k, g2)
tt100k <- mask(tt100k, g2)
writeRaster(tt100k, "./maps/markets/tt100k.tif")
rm(tmp)

# What is Bonny?
g2[g2$adm2_nm=="Bonny", "qd_agpot"]
# => -997, so AU
geo12[is.na(qd_agpot_clas), qd_agpot_clas := "AU"]
summary(factor(geo12$qd_agpot_clas))
#   AH   AL   AU
# 1997 1530 1371

# Make final quadrant classification for GHS
geo12[, seg_quad := paste0(qd_tt100k, qd_agpot_clas)]
geo12[, unique(seg_quad)]
# [1] "MHAU" "MHAL" "MHAH" "MLAH" "MLAL" "MLAU"
geo12[, seg_quad := ordered(seg_quad, levels=c("MLAU", "MLAL", "MLAH", "MHAU", "MHAL", "MHAH"))]

# Merge quadrants into `ghs`, `farm` and `ppp12`
setkey(geo12, hhid)
setkey(ghs, hhid)
setkey(farm, hhid)
setkey(ppp12, hhid)
ghs$seg_quad <- geo12[ghs][, seg_quad]
farm$seg_quad <- geo12[farm][, seg_quad]
ppp12$seg_quad <- geo12[ppp12][, seg_quad]

# Re-run summary tables
# => done

#####################################################################################
# Crop preferences across quadrants/zones - GHS
#####################################################################################

# Note that Cleo generated the hh-level vars and Eduardo estimated state-level vars
ghs.plot <- read.dta("./data/NGA-GHS/NGA_GHS_Indicator_plot_2012.dta")
ghs.plot <- data.table(ghs.plot)

# Merge in segmentation vars
setkey(geo12, hhid)
setkey(ghs.crop, hhid)
setkey(ghs.plot, hhid)
ghs.crop$seg_quad <- geo12[ghs.crop][, seg_quad]
ghs.plot$seg_quad <- geo12[ghs.plot][, seg_quad]
ghs.crop$seg_lvl_6 <- geo12[ghs.crop][, seg_lvl_6]
ghs.plot$seg_lvl_6 <- geo12[ghs.plot][, seg_lvl_6]

# Share of female plot managers
tmp <- ghs.plot[, .N, by=.(hhid, wt_w2v1, manager, state, gender)]

tmp <- ghs.crop[, .(
  num_fem_mgr=sum(num_fem_mgr*wt_wave2, na.rm=T)/sum(num_hh_mgr*wt_wave2, na.rm=T),
  fem_mgr=weighted.mean(num_fem_mgr>0, wt_wave2, na.rm=T),
  fem_earn=weighted.mean(fem_earn, wt_wave2, na.rm=T)
), keyby=seg_lvl_6]
tmp <- ghs.crop[, .(
  num_fem_mgr=sum(num_fem_mgr*wt_wave2, na.rm=T)/sum(num_hh_mgr*wt_wave2, na.rm=T),
  fem_mgr=weighted.mean(num_fem_mgr>0, wt_wave2, na.rm=T),
  fem_earn=weighted.mean(fem_earn, wt_wave2, na.rm=T)
), keyby=seg_quad]
tmp <- ghs.crop[, .(
  num_fem_mgr=sum(num_fem_mgr*wt_wave2, na.rm=T)/sum(num_hh_mgr*wt_wave2, na.rm=T),
  fem_mgr=weighted.mean(num_fem_mgr>0, wt_wave2, na.rm=T),
  fem_earn=weighted.mean(fem_earn, wt_wave2, na.rm=T))]


# Share of female-managed plots
tmp <- ghs.plot[, .(femplotmgr=weighted.mean(gender=="female", wt_w2v1, na.rm=T)),
  keyby=seg_lvl_6]
tmp <- ghs.plot[, .(femplotmgr=weighted.mean(gender=="female", wt_w2v1, na.rm=T)),
  keyby=seg_quad]
tmp <- ghs.plot[, .(femplotmgr=weighted.mean(gender=="female", wt_w2v1, na.rm=T))]


# TODO Area of female-managed plots under each crop
tmp <- ghs.plot[, lapply(.SD, sum, na.rm=T),
  keyby=.(hhid, wt_w2v1, state, gender), .SDcols=96:147]
tmp <- tmp[, lapply(.SD, function(x) sum(x*wt_w2v1, na.rm=T)),
  keyby=.(state, gender), .SDcols=c(2, 5:56)]
tmp[, wt_w2v1 := NULL]
tmp <- melt(tmp, id.vars=1:2)
tmp[, variable := str_replace(variable, "area_", "")]
tmp <- tmp[!is.na(gender)]

# Proportion of female-managed plots by crop
tmp <- melt(ghs.plot,
  id.vars=c("seg_quad", "seg_lvl_6", "gender", "wt_w2v1"),
  measure.vars=11:147)
tmp[value=="yes", value := "1"]
tmp[value=="no", value := "0"]
tmp[, value := as.numeric(value)]
tmp <- tmp[, lapply(.SD, weighted.mean, wt_w2v1), keyby=.(seg_lvl_6, gender, variable)]

# TODO Additional production stats
# TODO Also check on Sara's harmonized farm management stats

```


## Ghana

```{r gha-quad, eval=FALSE}

library(raster)
library(data.table)
library(viridis)

setwd("~/Projects/2017-agra-aasr")
load("./tmp/2017-agra-aasr_GHA.RData")

# For now we replicate Nigeria's quadrant classification above to Ghana using both 
# time-to-20K-market and time-to-50K-market layers.
# Load all 3 rasters and classify Ghana districts
qd.tt20k <- raster("~/Maps/cell5m/tt10_SSA_tiff/traveltimetomarket_ssa_020k.tif")
qd.tt50k <- raster("~/Maps/cell5m/tt10_SSA_tiff/traveltimetomarket_ssa_050k.tif")
qd.agpot <- raster("~/Maps/GAEZ_res03crav6190lsilrcer/res03_crav6190l_silr_cer.tif")

proj4string(qd.agpot)
# [1] "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
proj4string(qd.tt20k)
# [1] "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
proj4string(g2)
# [1] "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
res(qd.agpot)
# [1] 0.08333333 0.08333333
res(qd.tt20k)
# [1] 0.08333333 0.08333333

# Crop all layers to Ghana
qd.agpot <- crop(qd.agpot, g2)
qd.tt20k <- crop(qd.tt20k, g2)
qd.tt50k <- crop(qd.tt50k, g2)

# GAEZ color key from the documentation
unique(qd.agpot)
# [1] 1 2 3 4 5 6 9
qd.agpot.key <- c(
  `very high`=1,
  `high`=2,
  `good`=3,
  `medium`=4,
  `moderate`=5,
  `marginal`=6,
  `very marginal`=7,
  `not suitable`=8,
  `water`=9)

pal.agpot <- fread("
0	112	0	Dark green
21	174	17	Lime green
172	225	94	Conifer
254	216	1	Gold
206	157	83	Tussock
205	108	1	Sun
128	128	128	Aluminium
228	228	228	Athens grey
32	32	255	Blue")
pal.agpot <- rgb(pal.agpot[, .(V1, V2, V3)], maxColorValue=255)

qd.agpot.lbl <- c(
  "water",
  "protected area",
  "urban area",
  "irrigated area",
  "forest",
  "land not suited for agriculture",
  "land very poorly suited for pasture and at best poorly suited for rainfed crops",
  "land poorly suited for pasture and at best poorly suited for rainfed crops",
  "land suited for pasture and at best poorly suited for rainfed crops",
  "land suited for rainfed crops and pasture possible ",
  "land well suited for rainfed crops and pasture possible",
  "prime land suited for rainfed crops and pasture possible")

qd.agpot.lbl <- data.table(varCode=unique(qd.agpot), varLabel=qd.agpot.lbl)

summary(qd.tt20k)
# Min.                      0.0486763
# 1st Qu.                   1.1240800
# Median                    1.7141100
# 3rd Qu.                   2.5925300
# Max.                     12.9055996
# NA's                    350.0000000

# Resample time-to-market layers and GAEZ to 1km (from 10km)
plot(qd.tt20k)
spplot(qd.agpot)
qd.agpot <- disaggregate(qd.agpot, fact=10)
qd.tt20k <- disaggregate(qd.tt20k, fact=10, method="bilinear")
qd.tt50k <- disaggregate(qd.tt50k, fact=10, method="bilinear")
levels(qd.agpot) <- data.frame(ID=1:9, category=names(qd.agpot.key)) 

# Intersect with GHA district maps


# Compare with SDI version received on 2017.06.12
g2.qd <- fread("./out/SDI/gha-L2_stats.csv")
setkey(g2.qd, svyCode,svyL1Cd, svyL2Cd)
setkey(g2.dt, svyCode,svyL1Cd, svyL2Cd)
g2.dt[, seg_quad := NULL]
g2.dt[g2.qd, seg_quad := statsmedia]
unique(g2.dt$seg_quad)
# [1] NA  3  4  0  1  2
# lo-lo to hi-hi, where the first is ag potential and the second is market access
g2.dt[, seg_quad := factor(seg_quad, levels=1:4, 
  labels=c(
    "lo suit.-lo mkt.", 
    "lo suit.-hi mkt.", 
    "hi suit.-lo mkt.", 
    "hi suit.-hi mkt."))]

g2 <- SpatialPolygonsDataFrame(g2, data.frame(g2.dt), match.ID="rn")
spplot(g2[g2$svyCode=="gha-glss6", "seg_quad"], col.regions=pal.agpot[c(5,6,3,2)])
# => TODO should not be any district with NA value

#####################################################################################
# Compare with hi-res land cover (ESA, 2015)
qd.lc <- raster("~/Maps/ESA/ESACCI-LC-L4-LCCS-Map-300m-P1Y-2015-v2.0.7.tif")
qd.lc <- crop(qd.lc, g2)
qd.lc[qd.lc==0] <- NA

qd.lc.lbl <- fread("~/Maps/ESA/ESACCI-LC-Legend.csv")
setnames(qd.lc.lbl, 1:2, c("code", "class"))
qd.lc.lbl[, col := rgb(cbind(R,G,B), maxColorValue=255)]
qd.lc.lbl[, cat := str_replace_all(str_replace_all(abbreviate(toupper(class), 5), fixed("("), ""), fixed("/"), "")]
setkey(qd.lc.lbl, code)

spplot(qd.lc, col.regions=qd.lc.lbl[J(unique(qd.lc)), col], at=c(-1, unique(qd.lc)), 
  colorkey=list(at=1:23, labels=list(labels=qd.lc.lbl[J(unique(qd.lc)), cat], at=1:23+.5)))

#####################################################################################
# Compare with hi-res population density (Worldpop)


# Save workspace
rm(tmp, x, i)
save.image("./tmp/2017-agra-aasr_GHA.RData")

```

Using a combination of biophysical and infrastructure geospatial layers available over sub-Saharan African we identify zones of low/high agricultural potential and low/high market access in Ghana. This basket classification is useful to further characterize small farm holders across all 4 quadrants, and for targeting interventions and investments.

The input layers used for Ghana are as follows.

1. **Agricultural Potential** -- this measure was derived from [FAO/IIASA/GAEZ Cereal Suitability Index, 2007](http://www.fao.org/nr/gaez/about-data-portal/agricultural-suitability-and-potential-yields/en/) (rainfed, low-input). Soil suitability classifications are based on knowledge of crop requirements, of prevailing soil conditions, and of applied soil management. In other words, soil suitability procedures quantify to what extent soil conditions match crop requirements under defined input and management circumstances. 

Low and high potential areas are further classified as:

- 1-4 values are considered **low suitability**: 
    * `1` Land very poorly suited for pasture and at best poorly suited for rainfed crops  
    * `2` Land poorly suited for pasture and at best poorly suited for rainfed crops  
    * `3` Lands suited for pasture and at best poorly suited for rainfed crops  
    * `4` Land suited for rainfed crops and pasture possible  
- 5-6 values are considered **high suitability**:  
    * `5` Land well suited for rainfed crops and pasture possible  
    * `6` Prime land suited for rainfed crops and pasture possible  
- 809-0 is **unsuitable**:  
    * `-809` Protected area  
    * `-807` Urban area  
    * `-805` Irrigated area  
    * `-801` Forest  
    * `0` Land not suited for agriculture  

This classification is shown below along with a recent remote-sensed land cover layer. 
    
```{r gha-suitmap, fig.cap="Crop Suitability for Low-Input Rainfed Cereals. Source: FAO/IIASA/GAEZ, 2015.", dev="png"}

print(spplot(qd.agpot, col.regions=pal.agpot, 
  xlab=list("Crop Suitability for Low-Input Rainfed Cereals\n(FAO/IIASA/GAEZ)", cex=.9)), 
  split=c(1,1,2,1), more=T)

print(spplot(qd.lc, col.regions=qd.lc.lbl[J(unique(qd.lc)), col], 
  xlab=list("Land Cover Classification\n(ESA 2015)", cex=.9),
  at=c(-1, unique(qd.lc)), colorkey=list(at=1:23,
    labels=list(labels=qd.lc.lbl[J(unique(qd.lc)), cat], at=1:23+.5))),
  split=c(2,1,2,1), more=F)

```

```{r}

kable(qd.lc.lbl[, .(Code=code, Label=cat, Class=class)],
  caption="ESA Land Cover Classification")

```
    
2. **Market Access** -- Low and high market access areas are defined using a **4 hour** travel time threshold. The source is [IFPRI/HarvestChoice Travel Time to Markets in Africa South of the Sahara, 2016](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/YKDWJD) at 5-arc-minute resolution:

- `100` Low access (travel time greater than 4 hours)  
- `200` High access (travel time less than or equal to 4 hours)  

All layers were resampled to 1km and then we generated dominant classes across Ghana's districts (as household GPS locations are not available in any of the GLSS rounds).

```{r gha-ttmaps, fig.cap="Travel Time to Nearest 20K and 50K Market. Source: IFPRI/HarvestChoice, 2016.", dev="png"}

print(spplot(mask(qd.tt20k, g2[g2$svyCode=="gha-glss6",]),
  xlab="Travel Time to Nearest 20K Market (hrs)",
  col.regions=rev(inferno(30)), zlim=c(0,14), at=seq(0,14,.5)),
  split=c(1,1,2,1), more=T)

print(spplot(mask(qd.tt50k, g2[g2$svyCode=="gha-glss6",]),
  xlab="Travel Time to Nearest 50K Market (hrs)", 
  zlim=c(0,14), col.regions=rev(inferno(30)), at=seq(0,14,.5)),
  split=c(2,1,2,1), more=F)

```

The resulting cross-classification.

```{r gha-quadmap, fig.cap="Quadrant Classification across Districts, Ghana 2012/13. Source: authors.", dev="png"}

spplot(g2[g2$svyCode=="gha-glss6", "seg_quad"], col.regions=pal.agpot[c(5,6,3,2)], 
  xlab=list("Quadrant Classification across Districts", cex=.9))

```

